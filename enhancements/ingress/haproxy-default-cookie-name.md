---
title: haproxy-default-cookie-name
authors:
  - "@dudinea"
reviewers:
  - "@frobware"
  - "@knobunc"
  - "@Miciah"
  - "@candita"
  - "@miheer"
  - "@rfredette"
  - "@deads2k"
approvers:
  - "@frobware"
  - "@Miciah"
  - "@candita"
api-approvers:
  - "@deads2k"
creation-date: 2023-01-08
last-updated: 2023-01-08
tracking-link:
  - ?
---

# Default Session Cookie Name

## Release Signoff Checklist

- [X] Enhancement is `implementable`
- [ ] Design details are appropriately documented from clear requirements
- [ ] Test plan is defined
- [ ] Graduation criteria for dev preview, tech preview, GA
- [ ] User-facing documentation is created in [openshift-docs](https://github.com/openshift/openshift-docs/)

## Summary

The OpenShift router uses cookies to provide session persistence. The
name of the cookie is automatically generated by HAProxy unless this
behavior is overridden by per-route annotations
(router.openshift.io/cookie_name,
haproxy.router.openshift.io/disable_cookies, see
https://docs.openshift.com/container-platform/4.11/networking/routes/route-configuration.html#nw-using-cookies-keep-route-statefulness_route-configuration).

This enhancement proposes to add an API field `spec.cookieName` to the
`IngressController` CRD that will allow to configure default name of
session cookies.

## Motivation

### User Stories

For customers, which have many routes that are exposed via Application
firewalls that insist on closed list of supported cookies names or API
gateways that enforce strict conformance to OpenAPI definitions,
the manual per-route annotation of cookie names may be problematic.

The ability to change the name of HAProxy session cookies has been
available to OpenShift v3 administrators: they could change the
environment variable `ROUTER_COOKIE_NAME` in the router's deployment
configuration at will.  Adding this tuning option to OpenShift v4
restores this ability for customers migrating from OpenShift v3 and
may simplify their migration to OpenShift v4.

### Goals

1. Provide an API field for configuring the default name of session
   cookies for an IngressController.
2. Leave the default as it exists (auto-generated cookie name
   per-route) so that we don't perturb the behavior of existing
   clusters, especially during upgrades.

### Non-Goals

1. Export additional HAProxy abilities that are related to cookies or
   session persistence.

## Proposal

### API Extensions

Add a new field `spec.cookieName` to the IngressController API:

```go
// cookieName defines default name for the HTTP cookie that will be
// used for session persistence unless another behaviour is specified
// by route annotations.
//
// If empty, the cookie name will be auto-generated for each
// route (unless the route is annotated otherwise).
//
// Use the route annotation
// haproxy.router.openshift.io/disable_cookies to disable
// cookies or router.openshift.io/cookie_name to define a
// specific cookie name for the route.
//
// +optional
CookieName string `json:"cookieName,omitempty"`
```

### Implementation Details

When the `spec.cookieName` is defined and non-empty the 
operator will add the `ROUTER_COOKIE_NAME` environment variable 
with the given value to the router deployment. The variable
handling is already implemented by the router, so 
no changes on the router level are required.

### Risks and Mitigations

N/A

### Drawbacks

N/A

## Design Details

### Open Questions

N/A

### Test Plan

#### Unit Tests

Unit testing can validate:

- `spec.cookieName` sets the `ROUTER_COOKIE_NAME` environment variable
  correctly in the router deployment.
- when `spec.cookieName` is missing or empty the `ROUTER_COOKIE_NAME`
  environment variable is not present in the deployment.

#### E2E Testing

1. Create a new IngressController. Wait for an ingress controller pod
   to be deployed. Verify the router deployment does not have the
   environment variable `ROUTER_COOKIE_NAME` set. Call the
   `canary-openshift-ingress-canary.apps.<domain>` service and ensure
   it sets a cookie with an auto-generated name (a 64 digit long hex
   number).
2. Patch the IngressController to set `spec.cookieName` to value
   `OCPCOOKIE`. Wait for the ingress controller pod to be
   updated. Verify the router deployment has the environment
   variable `ROUTER_COOKIE_NAME` set to the same value. Call the
   `canary-openshift-ingress-canary.apps.<domain>` service and ensure
   it sets a cookie with name `OCPCOOKIE`
3. Patch the IngressController to remove  `spec.cookieName`.
   Wait for the ingress controller pod to be updated. 
   Verify the router deployment does not have environment variable 
   `ROUTER_COOKIE_NAME` set.

### Graduation Criteria

N/A. This enhancement does not require graduation milestones.

#### Dev Preview -> Tech Preview

N/A.  This feature will go directly to GA.

#### Tech Preview -> GA

N/A.  This feature will go directly to GA.

#### Removing a deprecated feature

N/A.  We do not plan to deprecate this feature.

### Upgrade / Downgrade Strategy

Upgrading from a previous release that does not have `spec.cookieName`
will leave the field blank, which is the default field value and keeps
existing router behavior (automatically generated cookie names).

#### Downgrading to a release without `spec.cookieName`

If `spec.cookieName` is set when downgrading to a
release without this field, the value will be discarded, and the
router will revert to its default behavior
(automatically generated cookie names).

### Version Skew Strategy

N/A

### Operational Aspects of API Extensions

#### Failure Modes

If the `spec.cookieName` is set to an invalid value (according to RFC-6265)
the router will fall back to its default behavior (automatically
generated cookie names).
 
#### Support Procedures

N/A

## Implementation History

## Alternatives

Other possible ways to get same functionality (constant cookie names)
without annotating all the routes:

- One can unmanage and disable the `cluster-ingress-operator` in the
cluster, and then configure the ROUTER_COOKIE_NAME variable in the
router deployment.
- One can provide a mutating webhook that will automatically annotate
routes with 'router.openshift.io/cookie_name'.

